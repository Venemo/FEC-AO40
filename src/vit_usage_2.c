#include <stdio.h>
#include <stdlib.h>
#include "../fec-3.0.1/fec.h"

#define MAXBYTES (10000)
#define SEED (1)
/*
  Compile with: `gcc -o vit_usage_1 vit_usage_1.c ../fec-3.0.1/libfec.a`
 */

#define CPOLYA 0x4f
#define CPOLYB 0x6d 

int main() {
  int i, j;
  void *vp;   
  int bit;    
  int sr = 0; 
  int framebits = 2560; 

  unsigned char symbols[2560*2+6];
  unsigned char encoded[320];
  unsigned char data[320];
  unsigned char enc_rs[] = {
    0x53, 0x4d, 0x4f, 0x47, 0x20, 0x74, 0x65, 0x6c, 0x65, 0x6d, 0x65, 0x74,
    0x72, 0x79, 0x20, 0x74, 0x65, 0x73, 0x74, 0x20, 0x6d, 0x65, 0x73, 0x73,
    0x61, 0x67, 0x65, 0x20, 0x76, 0x30, 0x2e, 0x31, 0x20, 0x2d, 0x20, 0x32,
    0x30, 0x31, 0x35, 0x2e, 0x30, 0x37, 0x2e, 0x32, 0x37, 0x2e, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00
  };

  FILE *fp;

  for (i = 0; i < framebits + 6; ++i) {
    if (i < framebits) {
      bit = (enc_rs[i/8] & 0x80) ? 1 : 0;
      enc_rs[i/8] <<= 1;
    } else {
      bit = 0;
    }

    
    /* Shift register: load the bit */
    sr = (sr << 1) | bit;

    //symbols[2*i+0] = addnoise(parity(sr & V27POLYA),gain,Gain,127.5,255);
    //symbols[2*i+1] = addnoise(parity(sr & V27POLYB),gain,Gain,127.5,255);
    symbols[2*i+0] = parity(sr & CPOLYB) ? 200 : 50;
    symbols[2*i+1] = (parity(sr & CPOLYA)) ? 200 : 50;
  }

  for (i = 0; i < framebits; ++i) {
    encoded[i/8] |= (symbols[i] > 128) ? 1 : 0;
    if ((i & 7) != 7) {
      encoded[i/8] <<= 1;
    }
  }

  printf("encoded data:\n");
  for (i = 0; i < (framebits / 8); ++i) {
    printf("%02x ", encoded[i]);
  }
  printf("\n\n");

  
  if ((vp = create_viterbi27(framebits)) == NULL) {
    printf("create_viterbi27 failed\n");
    exit(1);
  }
  i = init_viterbi27(vp, 0);
  i = update_viterbi27_blk(vp, symbols, framebits + 6);
  i = chainback_viterbi27(vp, data, framebits, 0);

  printf("decoded data:\n");
  for (i = 0; i < framebits / 8; ++i) {
    printf("%02x ", data[i]);
  }
  printf("\n\n");

  return 0;
}